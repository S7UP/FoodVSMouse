using System;
using System.Collections.Generic;

using S7P.Numeric;

using UnityEngine;
/// <summary>
/// 敌人的BOSS单位
/// </summary>
public class BossUnit : MouseUnit
{
    public SkillQueueAbilityManager mSkillQueueAbilityManager; // 技能队列管理器
    private static BoolModifier IgnoreSomeEffectModifier = new BoolModifier(true);
    private System.Random rand; // 随机数生成器
    private Dictionary<int, int> seedDict = new Dictionary<int, int>(); // 作用于本随机数生成器的种子字典，key表示初始行，value表示对应种子号
    private int SeedValue; // 当前种子值
    private Stack<Vector2> nextGridStack = new Stack<Vector2>(); // 下一个格子坐标栈，如果栈为空则让随机数生成器生成一个值并进栈 
    protected Dictionary<string, float[]> BossParamArrayDict = new Dictionary<string, float[]>(); // boss参数字典
    private Dictionary<string, List<Action<float[]>>> ParamChangeActionListDict = new Dictionary<string, List<Action<float[]>>>(); // 当参数字典中的参数发生改变时的事件

    private BoolModifier BossNoTargetAttackModeModifier = new BoolModifier(true); // BOSS无限攻击tag
    private FloatModifier burnRateMod = new FloatModifier(0.05f); // BOSS受灰烬效果比率

    public override void Awake()
    {
        mSkillQueueAbilityManager = new SkillQueueAbilityManager(this);
        base.Awake();
    }

    public override void MInit()
    {
        ParamChangeActionListDict.Clear();
        SeedValue = 0;
        mSkillQueueAbilityManager.Initial();
        rand = null;
        seedDict.Clear();
        nextGridStack.Clear();
        BossParamArrayDict.Clear();
        BossParamInit(); // 初始化BOSS参数
        base.MInit();
        InitHertRateList();
        isBoss = true;
        // 免疫控制效果
        AddBossIgnoreDebuffEffect(this);
        // BOSS不执行正常敌人前进逻辑
        NumericBox.Attack.SetBase(10);
        NumericBox.AttackSpeed.SetBase(1);
        NumericBox.MoveSpeed.SetBase(0);
        // 为全场添加无限攻击TAG
        GameController.Instance.AddNoTargetAttackModeModifier(BossNoTargetAttackModeModifier);
    }

    public override void MUpdate()
    {
        base.MUpdate();
        mSkillQueueAbilityManager.Update();
    }

    public override void MDestory()
    {
        // 移除全场无限攻击TAG
        GameController.Instance.RemoveNoTargetAttackModeModifier(BossNoTargetAttackModeModifier);
        mSkillQueueAbilityManager.Initial();
        base.MDestory();
    }

    public override void BeforeDeath()
    {
        base.BeforeDeath();
        mSkillQueueAbilityManager.Initial();
    }


    public override void BeforeBurn()
    {
        BeforeDeath();
    }

    public override void OnMoveStateEnter()
    {
        
    }

    public override void OnMoveState()
    {
        
    }

    public override void SetUnitType()
    {
        mUnitType = UnitType.Boss;
    }

    /// <summary>
    /// 获取种子表
    /// </summary>
    public void LoadSeedDict()
    {
        seedDict.Clear();
        for (int i = 0; i < 7; i++)
        {
            seedDict.Add(i, i);
        }
    }

    /// <summary>
    /// 通过初始行获取特定随机数种子，以设置该BOSS随机数生成器的种子
    /// </summary>
    /// <param name="rowIndex">若key不存在则采用默认的随机构造方法</param>
    public void SetRandSeedByRowIndex(int rowIndex)
    {
        SeedValue = rowIndex;
        if (seedDict.ContainsKey(rowIndex))
            rand = new System.Random(seedDict[rowIndex]);
        else
            rand = new System.Random();
    }

    /// <summary>
    /// 设置下一个格子的格子坐标
    /// </summary>
    /// <param name="xIndex"></param>
    /// <param name="yIndex"></param>
    public void SetNextGridIndex(int xIndex, int yIndex, float xIndexOffset, float yIndexOffset)
    {
        nextGridStack.Push(new Vector2(xIndex + xIndexOffset, yIndex + yIndexOffset));
    }

    public void SetNextGridIndex(int xIndex, int yIndex)
    {
        SetNextGridIndex(xIndex, yIndex, 0, 0);
    }

    /// <summary>
    /// 通过随机的方法设置下一个格子的格子坐标(左右都是开区间）
    /// </summary>
    public void SetNextGridIndexByRandom(int xIndexMin, int xIndexMax, int yIndexMin, int yIndexMax, float xIndexOffset, float yIndexOffset)
    {
        nextGridStack.Push(new Vector2(rand.Next(xIndexMin, xIndexMax + 1) + xIndexOffset, rand.Next(yIndexMin, yIndexMax + 1) + yIndexOffset));
    }

    public void SetNextGridIndexByRandom(int xIndexMin, int xIndexMax, int yIndexMin, int yIndexMax)
    {
        SetNextGridIndexByRandom(xIndexMin, xIndexMax, yIndexMin, yIndexMax, 0, 0);
    }

    /// <summary>
    /// 获取下一个前往的格子
    /// </summary>
    /// <returns></returns>
    public Vector2 GetNextGridIndex()
    {
        if (nextGridStack.Count > 0)
            return nextGridStack.Pop();
        return new Vector2(8, 3);
    }

    /// <summary>
    /// 获取BOSS自身随机数发射器的下一个随机数(左开右闭)
    /// </summary>
    /// <returns></returns>
    public int GetRandomNext(int min, int max)
    {
        return rand.Next(min, max);
    }

    /// <summary>
    /// 自动更新贴图
    /// </summary>
    public override void OnHertStageChanged()
    {
        OnUpdateRuntimeAnimatorController();
        // 锁定前几个阶段
        for (int i = 0; i < mHertIndex; i++)
        {
            mHertRateList[i] = float.MaxValue;
        }
        burnRateMod.Value = 1 - GetParamValue("burn_defence");
        NumericBox.BurnRate.RemoveModifier(burnRateMod);
        NumericBox.BurnRate.AddModifier(burnRateMod);
        // 重载技能组（狂暴）
        LoadSkillAbility();
    }

    /// <summary>
    /// 技能初始化模板（勿删）
    /// </summary>
    /// <param name="info"></param>
    //private CompoundSkillAbility PharaohCurseInit(SkillAbility.SkillAbilityInfo info)
    //{
    //    CompoundSkillAbility c = new CompoundSkillAbility(this, info);
    //    // 实现
    //    c.IsMeetSkillConditionFunc = delegate { return true; };
    //    c.BeforeSpellFunc = delegate
    //    {

    //    };
    //    {
    //        c.AddSpellingFunc(delegate {
    //            return true;
    //        });

    //    }
    //    c.OnNoSpellingFunc = delegate { };
    //    c.AfterSpellFunc = delegate { };
    //    return c;
    //}

    /// <summary>
    /// 为某个对象添加BOSS免疫异常状态效果
    /// </summary>
    public static void AddBossIgnoreDebuffEffect(BaseUnit unit)
    {
        // 免疫控制效果
        unit.NumericBox.AddDecideModifierToBoolDict(StringManager.IgnoreFrozen, IgnoreSomeEffectModifier);
        unit.NumericBox.AddDecideModifierToBoolDict(StringManager.IgnoreFrozenSlowDown, IgnoreSomeEffectModifier);
        unit.NumericBox.AddDecideModifierToBoolDict(StringManager.IgnoreSlowDown, IgnoreSomeEffectModifier);
        unit.NumericBox.AddDecideModifierToBoolDict(StringManager.IgnoreStun, IgnoreSomeEffectModifier);
        unit.NumericBox.AddDecideModifierToBoolDict(StringManager.IgnoreWaterGridState, IgnoreSomeEffectModifier);
    }

    public override bool IsOutOfBound()
    {
        return false;
    }

    /// <summary>
    /// 在与猫判定时是否能触发猫
    /// </summary>
    /// <returns></returns>
    public override bool CanTriggerCat()
    {
        return false;
    }

    /// <summary>
    /// 在越过失败判定线后是否会触发游戏失败判定
    /// </summary>
    /// <returns></returns>
    public override bool CanTriggerLoseWhenEnterLoseLine()
    {
        return false;
    }

    private void BossParamInit()
    {
        // 切换阶段血量百分比
        AddParamArray("hpRate", new float[] { 0.5f, 0.2f });
        AddParamArray("burn_defence", new float[] { 0.95f });

        // 血量阶段点参数改变事件
        AddParamChangeAction("hpRate", delegate {
            InitHertRateList();
            UpdateHertMap();
        });

        InitBossParam();
    }



    /// <summary>
    /// 初始化BOSS的参数
    /// </summary>
    protected virtual void InitBossParam()
    {

    }

    /// <summary>
    /// 根据给定的hpRate的值来设置BOSS切换阶段点
    /// </summary>
    public void InitHertRateList()
    {
        mHertRateList.Clear();
        float[] hpRate = BossParamArrayDict["hpRate"];
        foreach (var item in hpRate)
        {
            mHertRateList.Add(item);
        }
    }

    /// <summary>
    /// 添加一个参数
    /// </summary>
    public void AddParamArray(string key, float[] arr)
    {
        if (!BossParamArrayDict.ContainsKey(key))
            BossParamArrayDict.Add(key, arr);
        else
        {
            Debug.LogWarning("BOSS中已存在名为“" + key + "”的参数！传进来的新参数数组会覆盖原来的数组！");
            BossParamArrayDict[key] = arr;
        }

        // 特殊参数处理
        if (ParamChangeActionListDict.ContainsKey(key))
            foreach (var action in ParamChangeActionListDict[key])
                action(arr);
    }

    public void AddParamArray(string key, List<float> list)
    {
        AddParamArray(key, list.ToArray());
    }

    /// <summary>
    /// 获取参数值
    /// </summary>
    /// <param name="key"></param>
    /// <returns>如果没有key或者其中的数组为0，则返回0且报warning，如果有且没有越界，则正常返回，否则返回数组最后一位</returns>
    public float GetParamValue(string key, int stage)
    {
        if (BossParamArrayDict.ContainsKey(key) && BossParamArrayDict[key].Length>0)
        {
            float[] arr = BossParamArrayDict[key];
            if (stage < arr.Length)
                return arr[stage];
            else
                return arr[arr.Length-1];
        }
        else
        {
            Debug.LogWarning("BOSS中未发现名为“"+key+"”的参数！");
            return 0;
        }
    }

    public float GetParamValue(string key)
    {
        return GetParamValue(key, mHertIndex);
    }

    public float[] GetParamArray(string key)
    {
        if (BossParamArrayDict.ContainsKey(key) && BossParamArrayDict[key].Length > 0)
        {
            return BossParamArrayDict[key];
        }
        else
        {
            return null;
        }
    }

    /// <summary>
    /// 是否不存在或者越界
    /// </summary>
    /// <param name="key"></param>
    /// <param name="stage"></param>
    /// <returns></returns>
    public bool IsParamValueInValidOrOutOfBound(string key, int stage)
    {
        if (BossParamArrayDict.ContainsKey(key) && BossParamArrayDict[key].Length > 0)
        {
            float[] arr = BossParamArrayDict[key];
            if (stage < arr.Length)
                return false;
            else
                return true;
        }
        return true;
    }

    public int GetSeedValue()
    {
        return SeedValue;
    }

    /// <summary>
    /// 获取当前阶段数
    /// </summary>
    /// <returns></returns>
    public int GetStage()
    {
        return Mathf.Max(0, Mathf.Min(mHertIndex, GetParamArray("hpRate").Length));
    }

    /// <summary>
    /// 获取当前阶段点到下一个阶段点所需要达到的生命值百分比（小数）
    /// </summary>
    /// <param name="stage"></param>
    /// <returns></returns>
    private float GetHpPercent(int stage)
    {
        float[] arr = GetParamArray("hpRate");
        stage = Mathf.Max(0, Mathf.Min(stage, arr.Length));
        if (stage == arr.Length)
            return 0;
        return Mathf.Max(0, Mathf.Min(arr[stage], 1));
    }

    public float GetStageTotalHp(int stage)
    {
        float[] arr = GetParamArray("hpRate");
        if (stage == 0)
        {
            if (arr.Length == 0)
                return mMaxHp;
            else
                return mMaxHp * (1 - GetHpPercent(stage));
        }
        else if (stage == arr.Length)
            return mMaxHp * GetHpPercent(stage - 1);
        return mMaxHp * (GetHpPercent(stage - 1) - GetHpPercent(stage));
    }

    /// <summary>
    /// 获取当前阶段的总生命值
    /// </summary>
    /// <returns></returns>
    public float GetCurrentStageTotalHp()
    {
        return GetStageTotalHp(GetStage());
    }

    public float GetStageLeftHp(int stage)
    {
        float[] arr = GetParamArray("hpRate");
        if (arr.Length == 0)
            return mCurrentHp;
        else
            return mCurrentHp - mMaxHp * GetHpPercent(stage);
    }

    /// <summary>
    /// 获取当前阶段的剩余生命值
    /// </summary>
    /// <returns></returns>
    public float GetCurrentStageLeftHp()
    {
        return GetStageLeftHp(GetStage());
    }

    /// <summary>
    /// 跳到下一阶段
    /// </summary>
    public void SkipStage()
    {
        if (mHertIndex == 0)
            mHertRateList.Insert(mHertIndex, 1.0f);
        else
            mHertRateList.Insert(mHertIndex, mHertRateList[mHertIndex - 1]);
        mHertIndex++;
        OnHertStageChanged();
    }

    /// <summary>
    /// 添加当参数字典发生改变时的事件
    /// </summary>
    /// <param name="key"></param>
    /// <param name="action"></param>
    public void AddParamChangeAction(string key, Action<float[]> action)
    {
        if (!ParamChangeActionListDict.ContainsKey(key))
            ParamChangeActionListDict.Add(key, new List<Action<float[]>>());
        ParamChangeActionListDict[key].Add(action);
    }

    /// <summary>
    /// 移除当参数字典发生改变时的事件
    /// </summary>
    /// <param name="key"></param>
    /// <param name="action"></param>
    public void RemoveParamChangeAction(string key, Action<float[]> action)
    {
        if (ParamChangeActionListDict.ContainsKey(key))
            ParamChangeActionListDict[key].Remove(action);
    }
}
